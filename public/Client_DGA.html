<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DGA Connect Test - Dark Minimal</title>

    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Material+Icons|Material+Icons+Round" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        /* Global Styles (Dark Minimal Theme) */
        body { font-family: 'Prompt', sans-serif; margin: 0; background-color: #1a1a2e; color: #e0e0e0; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; padding: 40px 20px; box-sizing: border-box; }
        .container { max-width: 900px; width: 100%; background: #24243e; padding: 30px; border-radius: 12px; box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4); display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        h1 { grid-column: 1 / -1; color: #00bcd4; text-align: center; margin-bottom: 40px; font-weight: 700; font-size: 2.2em; }
        h2 { color: #00bcd4; font-weight: 600; font-size: 1.5em; margin-bottom: 20px; border-bottom: 1px solid rgba(0, 188, 212, 0.3); padding-bottom: 10px; }
        .card { background-color: #2e2e4f; border-radius: 8px; padding: 25px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3); display: flex; flex-direction: column; }
        .data-row { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 12px; padding-bottom: 5px; border-bottom: 1px dashed rgba(255, 255, 255, 0.1); }
        .data-row:last-child { border-bottom: none; }
        .data-label { font-weight: 500; color: #a0a0a0; flex-shrink: 0; margin-right: 15px; }
        .data-value { color: #e0e0e0; text-align: right; flex-grow: 1; word-break: break-all; }
        .button-group { grid-column: 1 / -1; text-align: center; margin-top: 40px; }
        button { background-color: #00bcd4; color: #fff; border: none; padding: 12px 25px; border-radius: 6px; cursor: pointer; font-size: 1.1em; font-weight: 600; transition: background-color 0.3s ease, transform 0.2s ease; }
        button:hover { background-color: #00a0b2; transform: translateY(-2px); }
        button:disabled { background-color: #555; cursor: not-allowed; transform: none; }
        .status-section { grid-column: 1 / -1; margin-top: 30px; }
        .log-box { background-color: #1a1a2e; padding: 18px; border-radius: 8px; margin-top: 15px; font-family: 'Consolas', 'Monaco', monospace; font-size: 0.85em; max-height: 250px; overflow-y: auto; white-space: pre-wrap; word-wrap: break-word; border: 1px solid rgba(0, 188, 212, 0.2); }
        .log-box p { margin: 0; padding: 3px 0; color: #b0b0b0; }
        .log-box p.error { color: #ff6b6b; }
        .log-box p.success { color: #6bff6b; }
        .log-box p.info { color: #a0a0a0; }
        .message { margin-top: 15px; padding: 10px 15px; border-radius: 6px; font-weight: 600; text-align: center; }
        .message.error { background-color: #4f2e2e; color: #ff6b6b; border: 1px solid #ff6b6b; }
        .message.success { background-color: #2e4f2e; color: #6bff6b; border: 1px solid #6bff6b; }
        .message.info { background-color: #2e2e4f; color: #00bcd4; border: 1px solid #00bcd4; }
        .loading-spinner { border: 4px solid rgba(0, 188, 212, 0.3); width: 24px; height: 24px; border-radius: 50%; border-left-color: #00bcd4; animation: spin 1s ease infinite; display: inline-block; vertical-align: middle; margin-left: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @media (max-width: 768px) { .container { grid-template-columns: 1fr; gap: 20px; padding: 20px; } h1 { font-size: 1.8em; margin-bottom: 30px; } h2 { font-size: 1.3em; margin-bottom: 15px; } .button-group { margin-top: 30px; } button { font-size: 1em; padding: 10px 20px; } }
    </style>
</head>
<body>
    <div class="container">
        <h1>‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ DGA Connect</h1>

        <div class="card">
            <h2>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</h2>
            <div class="data-row"><span class="data-label">‡∏£‡∏´‡∏±‡∏™‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô:</span><span id="citizenId" class="data-value">-</span></div>
            <div class="data-row"><span class="data-label">‡∏ä‡∏∑‡πà‡∏≠:</span><span id="firstName" class="data-value">-</span></div>
            <div class="data-row"><span class="data-label">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•:</span><span id="lastName" class="data-value">-</span></div>
            <div class="data-row"><span class="data-label">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠:</span><span id="mobile" class="data-value">-</span></div>
            <div class="data-row"><span class="data-label">‡∏≠‡∏µ‡πÄ‡∏°‡∏•:</span><span id="email" class="data-value">-</span></div>
        </div>

        <div class="card">
            <h2>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏∞‡∏ö‡∏ö</h2>
            <div class="data-row"><span class="data-label">App ID:</span><span id="appId" class="data-value">MOCK_APP_ID_FOR_TESTING</span></div> 
            <div class="data-row"><span class="data-label">mToken:</span><span id="mToken" class="data-value">MOCK_DGA_MTOKEN_FOR_TESTING</span></div>
            <div class="data-row"><span class="data-label">Agent ID:</span><span id="agentId" class="data-value">-</span></div>
            <div class="data-row"><span class="data-label">Consumer Key:</span><span id="consumerKey" class="data-value">-</span></div>
        </div>

        <div class="button-group">
            <button id="refreshDataBtn">
                üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• <span id="loadingSpinner" class="loading-spinner" style="display: none;"></span>
            </button>
        </div>

        <div class="status-section">
            <div id="statusMessage" class="message info">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°</div>
            <h2>Log</h2>
            <div id="logOutput" class="log-box"></div>
        </div>
    </div>

    <script>
        const logOutput = document.getElementById('logOutput');
        const statusMessage = document.getElementById('statusMessage');
        const refreshDataBtn = document.getElementById('refreshDataBtn');
        const loadingSpinner = document.getElementById('loadingSpinner');

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Log/Status
        function appendLog(message, type = 'info') {
            const time = new Date().toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            const logEntry = document.createElement('p');
            logEntry.className = type;
            logEntry.innerHTML = `[${time}] ${message}`;
            logOutput.prepend(logEntry);
        }

        function setStatus(message, type = 'info') {
            statusMessage.textContent = message;
            statusMessage.className = `message ${type}`;
        }

        async function fetchDGAData() {
            loadingSpinner.style.display = 'inline-block';
            refreshDataBtn.disabled = true;
            setStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...', 'info');
            logOutput.innerHTML = ''; // Clear log
            appendLog('‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• DGA...', 'info');

            try {
                const urlParams = new URLSearchParams(window.location.search);
                
                // 1. ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å URL Params ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤ Mock ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÉ‡∏ô HTML
                const appId = urlParams.get('appId') || document.getElementById('appId').textContent;
                const mToken = urlParams.get('mToken') || document.getElementById('mToken').textContent; 
                
                // Update UI (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡πà‡∏≤ Mock/‡∏à‡∏£‡∏¥‡∏á‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ)
                document.getElementById('mToken').textContent = mToken;
                document.getElementById('appId').textContent = appId;
                
                if (mToken.includes('MOCK') || appId.includes('MOCK')) {
                     appendLog('‚ö†Ô∏è ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤ MOCK App ID ‡∏´‡∏£‡∏∑‡∏≠ MToken ‡∏≠‡∏≤‡∏à‡∏ó‡∏≥‡πÉ‡∏´‡πâ API ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß', 'warn');
                }

                // 2. ‚úÖ Validate ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ç‡∏≠ Token (API: /test5/api/validate)
                appendLog('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏Å /test5/api/validate...', 'info');
                const validateRes = await axios.get("/test5/api/validate"); 
                
                const token = validateRes.data.token;
                
                // ‡∏î‡∏∂‡∏á Agent ID ‡πÅ‡∏•‡∏∞ Consumer Key ‡∏à‡∏≤‡∏Å Response ‡∏Ç‡∏≠‡∏á /validate
                document.getElementById('agentId').textContent = validateRes.data.agentId || '-';
                document.getElementById('consumerKey').textContent = validateRes.data.consumerKey || '-';

                appendLog(`‚úÖ ‡πÑ‡∏î‡πâ Access Token: ${token.substring(0, 10)}...`, 'success');

                // 3. ‚úÖ Login, ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ, ‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å/‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï (API: /test5/api/login)
                appendLog('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏Å /test5/api/login...', 'info');
                
                // ‡∏™‡πà‡∏á appId, mToken, ‡πÅ‡∏•‡∏∞ token ‡πÑ‡∏õ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô‡πÉ‡∏ô body (‡∏ï‡∏≤‡∏° API.js Logic)
                const loginRes = await axios.post("/test5/api/login", { 
                    appId: appId,
                    mToken: mToken,
                    token: token 
                });
                
                const userData = loginRes.data.user;
                appendLog('‚úÖ ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô MongoDB', 'success');

                // 4. ‚úÖ ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
                document.getElementById('citizenId').textContent = userData.citizenId || '-';
                document.getElementById('firstName').textContent = userData.firstName || '-';
                document.getElementById('lastName').textContent = userData.lastName || '-';
                document.getElementById('mobile').textContent = userData.mobile || '-'; // ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö ID ‡πÉ‡∏ô HTML
                document.getElementById('email').textContent = userData.email || '-'; // ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö ID ‡πÉ‡∏ô HTML

                setStatus('‚úîÔ∏è ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß', 'success');

            } catch (error) {
                console.error("Error fetching DGA data:", error);
                let errorMessage = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
                
                if (error.response) {
                    errorMessage = `${error.response.status} - ${error.response.data.message || error.response.statusText}`;
                    appendLog(`API Error: ${errorMessage}`, 'error');
                } else if (error.request) {
                    errorMessage = `Network/Connection Error: ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏™‡∏ô‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå`;
                    appendLog('Network Error: ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏™‡∏ô‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå', 'error');
                } else {
                    errorMessage = `General Error: ${error.message}`;
                    appendLog(`‚ùå ${errorMessage}`, 'error');
                }
                setStatus(`‚ùå ${errorMessage}`, 'error');
            } finally {
                loadingSpinner.style.display = 'none';
                refreshDataBtn.disabled = false;
            }
        }

        // Run fetchDGAData ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏°
        document.getElementById('refreshDataBtn').addEventListener('click', fetchDGAData);
        
        // ‡∏£‡∏±‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤ (‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£)
        window.addEventListener('load', fetchDGAData); 
    </script>
</body>
</html>