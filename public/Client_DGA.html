<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DGA Integration Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;700&display=swap');
        body { font-family: 'Sarabun', sans-serif; }
        .step-card { transition: all 0.3s ease; }
        .step-card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        pre { white-space: pre-wrap; word-wrap: break-word; }
    </style>
</head>
<body class="bg-slate-100 min-h-screen py-10 px-4">

    <div class="max-w-5xl mx-auto">
        <!-- Header -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6 border-l-8 border-blue-600">
            <h1 class="text-2xl font-bold text-slate-800"><i class="fa-solid fa-shield-halved mr-2"></i>DGA Client Test Panel</h1>
            <p class="text-slate-500 mt-1">หน้าทดสอบการเชื่อมต่อ API กับ e-Gov (DGA) และระบบสมาชิก MongoDB</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <!-- Left Column: Controls -->
            <div class="lg:col-span-2 space-y-6">
                
                <!-- Step 1: Validate -->
                <div class="step-card bg-white rounded-xl shadow p-6 relative overflow-hidden">
                    <div class="absolute top-0 right-0 bg-blue-100 text-blue-800 text-xs font-bold px-2 py-1 rounded-bl-lg">STEP 1</div>
                    <h2 class="text-lg font-bold text-blue-700 mb-4"><i class="fa-solid fa-key mr-2"></i>Authentication (Validate)</h2>
                    <p class="text-sm text-gray-500 mb-4">ขอ Token จาก DGA เพื่อใช้ยืนยันตัวตนในขั้นตอนถัดไป</p>
                    
                    <button onclick="validateToken()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition flex items-center justify-center gap-2">
                        <i class="fa-solid fa-check-circle"></i> ขอ Token (Validate)
                    </button>

                    <div id="token-display" class="mt-3 hidden p-3 bg-green-50 border border-green-200 rounded text-xs text-green-800 font-mono break-all">
                        <!-- Token will appear here -->
                    </div>
                </div>

                <!-- Step 2: Login / Get User Data -->
                <div class="step-card bg-white rounded-xl shadow p-6 relative overflow-hidden opacity-50 pointer-events-none transition-all" id="step-login">
                    <div class="absolute top-0 right-0 bg-indigo-100 text-indigo-800 text-xs font-bold px-2 py-1 rounded-bl-lg">STEP 2</div>
                    <h2 class="text-lg font-bold text-indigo-700 mb-4"><i class="fa-solid fa-user-check mr-2"></i>Login / Get User Data</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">App ID</label>
                            <input type="text" id="appId" value="7938515d-0bf0-4445-99b3-d941e9c72136" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">mToken (User Token)</label>
                            <input type="text" id="mToken" placeholder="ใส่ mToken ของผู้ใช้จริง" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                    </div>

                    <button onclick="loginDGA()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded transition flex items-center justify-center gap-2">
                        <i class="fa-solid fa-cloud-download-alt"></i> ดึงข้อมูล + บันทึกลง DB
                    </button>
                </div>

                <!-- Step 3: Notification -->
                <div class="step-card bg-white rounded-xl shadow p-6 relative overflow-hidden opacity-50 pointer-events-none transition-all" id="step-noti">
                    <div class="absolute top-0 right-0 bg-red-100 text-red-800 text-xs font-bold px-2 py-1 rounded-bl-lg">STEP 3</div>
                    <h2 class="text-lg font-bold text-red-700 mb-4"><i class="fa-solid fa-bell mr-2"></i>Send Notification</h2>
                    
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">User ID (จาก Step 2)</label>
                        <input type="text" id="userId" readonly class="bg-gray-100 shadow appearance-none border rounded w-full py-2 px-3 text-gray-500 leading-tight cursor-not-allowed">
                    </div>

                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">ข้อความแจ้งเตือน</label>
                        <textarea id="notiMessage" rows="2" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-red-500">ทดสอบการส่งแจ้งเตือนจากระบบ Node.js</textarea>
                    </div>

                    <button onclick="sendNoti()" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded transition flex items-center justify-center gap-2">
                        <i class="fa-solid fa-paper-plane"></i> ส่งแจ้งเตือน
                    </button>
                </div>
            </div>

            <!-- Right Column: Logs -->
            <div class="bg-slate-900 rounded-xl shadow-lg p-4 text-slate-300 font-mono text-sm flex flex-col h-[600px] overflow-hidden">
                <div class="flex justify-between items-center border-b border-slate-700 pb-2 mb-2">
                    <span class="font-bold text-green-400">Server Response Log</span>
                    <button onclick="document.getElementById('logs').innerHTML=''" class="text-xs text-slate-500 hover:text-white">Clear</button>
                </div>
                <div id="logs" class="flex-1 overflow-y-auto space-y-3 pr-2 custom-scrollbar">
                    <p class="text-slate-600 italic">Waiting for actions...</p>
                </div>
            </div>

        </div>
    </div>

    <script>
        // Global Variables
        let currentToken = '';
        let currentAgentId = '';

        // Helper: Log to UI
        function log(title, data, isError = false) {
            const logContainer = document.getElementById('logs');
            if (logContainer.innerHTML.includes('Waiting for actions...')) logContainer.innerHTML = '';

            const time = new Date().toLocaleTimeString();
            const colorClass = isError ? 'text-red-400' : 'text-blue-400';
            
            const html = `
                <div class="border-l-2 ${isError ? 'border-red-500' : 'border-blue-500'} pl-3 fade-in">
                    <div class="flex justify-between text-xs text-slate-500">
                        <span>${time}</span>
                        <span class="${colorClass} font-bold">${title}</span>
                    </div>
                    <pre class="mt-1 text-xs text-slate-300">${typeof data === 'object' ? JSON.stringify(data, null, 2) : data}</pre>
                </div>
            `;
            logContainer.insertAdjacentHTML('afterbegin', html);
        }

        // Step 1: Validate
        async function validateToken() {
            try {
                log('REQ', 'Fetching /test5/api/validate...');
                const res = await fetch('/test5/api/validate');
                const data = await res.json();

                if (data.success) {
                    currentToken = data.token;
                    currentAgentId = data.agentId;
                    
                    // UI Update
                    document.getElementById('token-display').innerHTML = `<i class="fa-solid fa-key"></i> <b>Token:</b> ${currentToken.substring(0, 20)}...`;
                    document.getElementById('token-display').classList.remove('hidden');
                    
                    // Unlock Step 2
                    const step2 = document.getElementById('step-login');
                    step2.classList.remove('opacity-50', 'pointer-events-none');
                    step2.classList.add('ring-2', 'ring-indigo-200');

                    log('RES (Success)', data);
                } else {
                    log('RES (Error)', data, true);
                }
            } catch (err) {
                log('ERROR', err.message, true);
            }
        }

        // Step 2: Login
        async function loginDGA() {
            const appId = document.getElementById('appId').value;
            const mToken = document.getElementById('mToken').value;

            if (!mToken) {
                alert('กรุณากรอก mToken (จำลอง)');
                return;
            }

            try {
                log('REQ', `Posting /test5/api/login with mToken: ${mToken}...`);
                const res = await fetch('/test5/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ appId, mToken, token: currentToken })
                });
                const data = await res.json();

                if (data.success) {
                    log('RES (Success)', data);
                    
                    // Auto fill User ID for next step
                    if (data.user && data.user.userId) {
                        document.getElementById('userId').value = data.user.userId;
                        
                        // Unlock Step 3
                        const step3 = document.getElementById('step-noti');
                        step3.classList.remove('opacity-50', 'pointer-events-none');
                        step3.classList.add('ring-2', 'ring-red-200');
                    }
                } else {
                    log('RES (Error)', data, true);
                }
            } catch (err) {
                log('ERROR', err.message, true);
            }
        }

        // Step 3: Notification
        async function sendNoti() {
            const appId = document.getElementById('appId').value;
            const userId = document.getElementById('userId').value;
            const message = document.getElementById('notiMessage').value;

            try {
                log('REQ', `Sending Notification to ${userId}...`);
                const res = await fetch('/test5/api/notification', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        appId, 
                        userId, 
                        token: currentToken, 
                        message 
                    })
                });
                const data = await res.json();
                
                if (data.success) {
                    log('RES (Success)', data);
                } else {
                    log('RES (Error)', data, true);
                }
            } catch (err) {
                log('ERROR', err.message, true);
            }
        }
    </script>
</body>
</html>