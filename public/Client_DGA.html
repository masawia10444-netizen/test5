<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DGA Connect Test - Dark Minimal</title>

    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Material+Icons|Material+Icons+Round" rel="stylesheet">

    <link rel="stylesheet" href="style.css"> 

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ DGA Connect</h1>

        <div class="card">
            <h2>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</h2>
            <div class="data-row"><span class="data-label">‡∏£‡∏´‡∏±‡∏™‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô:</span><span id="citizenId" class="data-value">-</span></div>
            <div class="data-row"><span class="data-label">‡∏ä‡∏∑‡πà‡∏≠:</span><span id="firstName" class="data-value">-</span></div>
            <div class="data-row"><span class="data-label">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•:</span><span id="lastName" class="data-value">-</span></div>
            <div class="data-row"><span class="data-label">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠:</span><span id="mobile" class="data-value">-</span></div>
            <div class="data-row"><span class="data-label">‡∏≠‡∏µ‡πÄ‡∏°‡∏•:</span><span id="email" class="data-value">-</span></div>
        </div>

        <div class="card">
            <h2>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏∞‡∏ö‡∏ö</h2>
            <div class="data-row"><span class="data-label">App ID:</span><span id="appId" class="data-value">MOCK_APP_ID_FOR_TESTING</span></div> 
            <div class="data-row"><span class="data-label">mToken:</span><span id="mToken" class="data-value">MOCK_DGA_MTOKEN_FOR_TESTING</span></div>
            <div class="data-row"><span class="data-label">Agent ID:</span><span id="agentId" class="data-value">-</span></div>
            <div class="data-row"><span class="data-label">Consumer Key:</span><span id="consumerKey" class="data-value">-</span></div>
        </div>

        <div class="button-group">
            <button id="refreshDataBtn">
                üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• <span id="loadingSpinner" class="loading-spinner" style="display: none;"></span>
            </button>
        </div>

        <div class="status-section">
            <div id="statusMessage" class="message info">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°</div>
            <h2>Log</h2>
            <div id="logOutput" class="log-box"></div>
        </div>
    </div>

    <script>
        const logOutput = document.getElementById('logOutput');
        const statusMessage = document.getElementById('statusMessage');
        const refreshDataBtn = document.getElementById('refreshDataBtn');
        const loadingSpinner = document.getElementById('loadingSpinner');

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Log/Status (‡∏Ñ‡∏á‡πÑ‡∏ß‡πâ‡∏ï‡∏≤‡∏°‡πÄ‡∏î‡∏¥‡∏°)
        function appendLog(message, type = 'info') {
            const time = new Date().toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            const logEntry = document.createElement('p');
            logEntry.className = type;
            logEntry.innerHTML = `[${time}] ${message}`;
            logOutput.prepend(logEntry);
        }

        function setStatus(message, type = 'info') {
            statusMessage.textContent = message;
            statusMessage.className = `message ${type}`;
        }

        async function fetchDGAData() {
            loadingSpinner.style.display = 'inline-block';
            refreshDataBtn.disabled = true;
            setStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...', 'info');
            logOutput.innerHTML = '';
            appendLog('‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• DGA...', 'info');

            try {
                const urlParams = new URLSearchParams(window.location.search);
                
                // ‚úÖ ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å URL Params ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤ Mock ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÉ‡∏ô HTML
                const appId = urlParams.get('appId') || document.getElementById('appId').textContent;
                const mToken = urlParams.get('mToken') || document.getElementById('mToken').textContent; 

                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI
                document.getElementById('mToken').textContent = mToken;
                document.getElementById('appId').textContent = appId;
                
                if (mToken.includes('MOCK') || appId.includes('MOCK')) {
                     appendLog('‚ö†Ô∏è ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤ MOCK App ID ‡∏´‡∏£‡∏∑‡∏≠ MToken ‡∏≠‡∏≤‡∏à‡∏ó‡∏≥‡πÉ‡∏´‡πâ API ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß', 'error');
                }

                // 1. ‚úÖ Validate ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ç‡∏≠ Token (API: /test5/api/validate)
                appendLog('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏Å /test5/api/validate...', 'info');
                const validateRes = await axios.get("/test5/api/validate"); 
                
                const token = validateRes.data.token;
                // ‡∏î‡∏∂‡∏á Agent ID ‡πÅ‡∏•‡∏∞ Consumer Key ‡∏à‡∏≤‡∏Å Response ‡∏Ç‡∏≠‡∏á /validate (‡∏ñ‡πâ‡∏≤ Backend ‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤)
                document.getElementById('agentId').textContent = validateRes.data.agentId || '-';
                document.getElementById('consumerKey').textContent = validateRes.data.consumerKey || '-';

                appendLog(`‚úÖ ‡πÑ‡∏î‡πâ Access Token: ${token.substring(0, 10)}...`, 'success');

                // 2. ‚úÖ Login, ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ, ‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å/‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï (API: /test5/api/login)
                appendLog('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏Å /test5/api/login...', 'info');
                
                // ‡∏™‡πà‡∏á appId, mToken, ‡πÅ‡∏•‡∏∞ token ‡πÑ‡∏õ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô‡πÉ‡∏ô body (‡∏ï‡∏≤‡∏° API.js Logic)
                const loginRes = await axios.post("/test5/api/login", { 
                    appId: appId,
                    mToken: mToken,
                    token: token 
                });
                
                const userData = loginRes.data.user;
                appendLog('‚úÖ ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô MongoDB', 'success');

                // 3. ‚úÖ ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö ID ‡πÉ‡∏ô HTML)
                document.getElementById('citizenId').textContent = userData.citizenId || '-';
                document.getElementById('firstName').textContent = userData.firstName || '-';
                document.getElementById('lastName').textContent = userData.lastName || '-';
                // ‡πÉ‡∏ä‡πâ ID 'mobile' ‡πÅ‡∏•‡∏∞ 'email' ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏≤‡∏° HTML:
                document.getElementById('mobile').textContent = userData.mobile || '-';
                document.getElementById('email').textContent = userData.email || '-'; 

                setStatus('‚úîÔ∏è ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß', 'success');

            } catch (error) {
                console.error("Error fetching DGA data:", error);
                let errorMessage = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
                
                if (error.response) {
                    errorMessage = `${error.response.status} - ${error.response.data.message || error.response.statusText}`;
                    appendLog(`API Error: ${errorMessage}`, 'error');
                } else if (error.request) {
                    errorMessage = `Network/Connection Error: ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏™‡∏ô‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå`;
                    appendLog('Network Error: ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏™‡∏ô‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå', 'error');
                } else {
                    errorMessage = `General Error: ${error.message}`;
                    appendLog(`‚ùå ${errorMessage}`, 'error');
                }
                setStatus(`‚ùå ${errorMessage}`, 'error');
            } finally {
                loadingSpinner.style.display = 'none';
                refreshDataBtn.disabled = false;
            }
        }

        document.getElementById('refreshDataBtn').addEventListener('click', fetchDGAData);
    </script>
</body>
</html>